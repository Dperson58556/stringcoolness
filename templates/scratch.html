<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>String Card</title>

    <style>
      body {
        font-family: monospace;
        background: #0f0f0f;
        color: #eee;
        padding: 20px;
      }

      button {
        margin-left: 8px;
      }

      /* --- Card --- */

      .card {
        width: 360px;
        background: #1b1b1b;
        border-radius: 14px;
        padding: 16px;
        margin-top: 20px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.5);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 12px;
      }

      .card-title {
        font-size: 18px;
        font-weight: bold;
        letter-spacing: 1px;
      }

      .card-score {
        font-size: 20px;
        font-weight: bolder;
        color: #ffd700;
      }

      .string-display {
        font-size: 16px;
        letter-spacing: 2px;
        background: #111;
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 12px;
        text-align: center;
      }

      .stats {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 12px;
      }

      .stat {
        display: flex;
        justify-content: space-between;
      }

      .stat-name {
        color: #aaa;
      }

      .stat-value {
        font-weight: bold;
      }

      .subsection {
        margin-top: 10px;
      }

      .subsection-title {
        font-size: 12px;
        color: #888;
        margin-bottom: 4px;
        text-transform: uppercase;
      }

      .pill0 {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 2px 0px;
        width: 64px;
        border-radius: 6px;
        background: #030303;
        margin: 2px;
        font-size: 12px;
        color: #333333
      }

      .pill1 {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 2px 0px;
        width: 64px;
        border-radius: 6px;
        background: #333;
        margin: 2px;
        font-size: 12px;
        color: #aaaaaa
      }

      .pill2 {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 2px 0px;
        width: 64px;
        border-radius: 6px;
        background: rgb(0, 128, 24);
        margin: 2px;
        font-size: 12px;
      }

      .pill3 {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 2px 0px;
        width: 64px;
        border-radius: 6px;
        background: rgb(0, 119, 255);
        margin: 2px;
        font-size: 12px;
      }

      .pill4 {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 2px 0px;
        width: 64px;
        border-radius: 6px;
        background: rgb(191, 0, 255);
        margin: 2px;
        font-size: 12px;
      }

      .pill5 {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 2px 0px;
        width: 64px;
        border-radius: 6px;
        background: rgb(183, 101, 0);
        margin: 2px;
        font-size: 12px;
      }

      .pill6 {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 2px 0px;
        width: 64px;
        border-radius: 6px;
        background: rgb(167, 137, 0);
        margin: 2px;
        font-size: 12px;
      }

      .pill7 {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 2px 0px;
        width: 64px;
        border-radius: 6px;
        background: rgb(255, 0, 34);
        margin: 2px;
        font-size: 12px;
      }
    </style>
  </head>

  <body>

    <h1>String Scorer</h1>

    <div>
      <label>
        Length:
        <input id="length" type="number" value="8">
      </label>
      <button onclick="generate()">Generate</button>
    </div>

    <div>
      <label>
        test_string:
        <input id="test_string" type="text" value="teststring">
      </label>
      <button onclick="generate_test_string()">Generate</button>
    </div>

    <div id="results"></div>

    <script>
      async function generate() {
        const length = document.getElementById("length").value;
        const res = await fetch(`/generate?length=${length}`);
        const data = await res.json();

        const obj = Array.isArray(data) ? data[0] : data;

        const results = document.getElementById("results");
        results.innerHTML = "";

        results.appendChild(createCard(obj));
      }

      async function generate_test_string() {
        const test_string = document.getElementById("test_string").value;
        const res = await fetch(`/generate_test_string?test_string=${test_string}`);
        const data = await res.json();
        
        const obj = Array.isArray(data) ? data[0] : data;

        const results = document.getElementById("results");
        results.innerHTML = "";

        results.appendChild(createCard(obj));
      }

      function createCard(data) {
        const card = document.createElement("div");
        card.className = "card";

        /* --- Header --- */
        const header = document.createElement("div");
        header.className = "card-header";

        const title = document.createElement("div");
        title.className = "card-title";
        title.textContent = "STRING";

        const score = document.createElement("div");
        score.className = "card-score";
        score.textContent = data.total_points;

        header.appendChild(title);
        header.appendChild(score);

        /* --- String Display --- */
        const stringDisplay = document.createElement("div");
        stringDisplay.className = "string-display";
        stringDisplay.textContent = data.random_string;

        /* --- Stats --- */
        const stats = document.createElement("div");
        stats.className = "stats";

        stats.appendChild(makeStat("Length", data.random_string.length));
        stats.appendChild(makeStat("Entropy", data.entropy));
        stats.appendChild(makeStat("Percent Unique", data.percent_unique));

        /* --- Repeated Characters --- */
        const repeatsCharSection = document.createElement("div");
        repeatsCharSection.className = "subsection";

        const repeatsCharTitle = document.createElement("div");
        repeatsCharTitle.className = "subsection-title";
        repeatsCharTitle.textContent = "Repeated Characters";

        repeatsCharSection.appendChild(repeatsCharTitle);

        const letters = "abcdefghijklmnopqrstuvwxyz";
        const repeats = data.repeated_1_strs ?? {};

        letters.split("").forEach(letter => {
          const pill = document.createElement("span");
          const color_threshold = 7
          if (repeats[letter]) {
            pill.className = `pill${Math.min(color_threshold, repeats[letter])}`;
            if (repeats[letter] < 10) {
              if (repeats[letter] != 1) { 
                pill.textContent = `${letter} ×${repeats[letter]}`; 
              } else { pill.textContent = `${letter}`; }
            } else {
              pill.textContent = `${letter}×${repeats[letter]}`;
            }
          } else {
            pill.className = "pill0";
            pill.textContent = letter;
          }

          repeatsCharSection.appendChild(pill);
        });

        /* --- Repeated Chunks --- */
        const repeatsSection = document.createElement("div");
        repeatsSection.className = "subsection";

        const repeatsTitle = document.createElement("div");
        repeatsTitle.className = "subsection-title";
        repeatsTitle.textContent = "Repeated Chunks";

        repeatsSection.appendChild(repeatsTitle);

        if (data.repeated_chunks && Object.keys(data.repeated_chunks).length > 0) {
          Object.keys(data.repeated_chunks).forEach(key => {
            const r = {
              substr: key,
              count: data.repeated_chunks[key]
            };
            const pill = document.createElement("span");
            const color_threshold = 7
            pill.className = `pill${Math.min(color_threshold, r.substr.length)}`;
            pill.textContent = `${r.substr} ×${r.count}`;
            repeatsSection.appendChild(pill);
          });
        }
        else {
          const none = document.createElement("div");
          none.className = "pill0";
          none.textContent = "-";
          repeatsSection.appendChild(none);
        }

        /* --- Character Blocks --- */
        const blocksSection = document.createElement("div");
        blocksSection.className = "subsection";

        const blocksTitle = document.createElement("div");
        blocksTitle.className = "subsection-title";
        blocksTitle.textContent = "Character Blocks";

        blocksSection.appendChild(blocksTitle);

        if (data.char_blocks_dict && Object.keys(data.char_blocks_dict).length > 0) {
          Object.keys(data.char_blocks_dict).forEach(key => {
            const r = {
              substr: key,
              count: data.char_blocks_dict[key]
            };
            const pill = document.createElement("span");
            const color_threshold = 7
            pill.className = `pill${Math.min(color_threshold, r.substr.length)}`;
            pill.textContent = `${r.substr} ×${r.count}`;
            blocksSection.appendChild(pill);
          });
        }
        else {
          const none = document.createElement("div");
          none.className = "pill0";
          none.textContent = "-";
          blocksSection.appendChild(none);
        }

        /* --- Palindromic Blocks --- */
        const palindromesSection = document.createElement("div");
        palindromesSection.className = "subsection";

        const palindromesTitle = document.createElement("div");
        palindromesTitle.className = "subsection-title";
        palindromesTitle.textContent = "Palindromes Within";

        palindromesSection.appendChild(palindromesTitle);

        if (data.palindromes && data.palindromes.length > 0) {
          data.palindromes.forEach(key => {
            const r = {
              substr: key[2],
              word_len: key[2].length
            };
            const pill = document.createElement("span");
            const color_threshold = 7
            pill.className = `pill${Math.min(color_threshold, r.word_len - 1)}`;
            pill.textContent = `${r.substr}`;
            palindromesSection.appendChild(pill);
          });
        }
        else {
          const none = document.createElement("div");
          none.className = "pill0";
          none.textContent = "-";
          palindromesSection.appendChild(none);
        }


        /* --- Words Within --- */
        const wordsWithinSection = document.createElement("div");
        wordsWithinSection.className = "subsection";

        const wordsWithinTitle = document.createElement("div");
        wordsWithinTitle.className = "subsection-title";
        wordsWithinTitle.textContent = "Words Within";

        wordsWithinSection.appendChild(wordsWithinTitle);

        if (data.words_within && data.words_within.length > 0) {
          data.words_within.forEach(key => {
            const r = {
              substr: key[2],
              word_len: key[2].length
            };
            const pill = document.createElement("span");
            const color_threshold = 7
            pill.className = `pill${Math.min(color_threshold, r.word_len - 1)}`;
            pill.textContent = `${r.substr}`;
            wordsWithinSection.appendChild(pill);
          });
        }
        else {
          const none = document.createElement("div");
          none.className = "pill0";
          none.textContent = "-";
          wordsWithinSection.appendChild(none);
        }

        /* --- Assemble Card --- */
        card.appendChild(header);
        card.appendChild(stringDisplay);
        card.appendChild(stats);
        card.appendChild(repeatsCharSection);
        card.appendChild(repeatsSection);
        card.appendChild(blocksSection);
        card.appendChild(wordsWithinSection);
        card.appendChild(palindromesSection);

        return card;
      }

      function makeStat(name, value) {
        if (name == "Percent Unique"){
          value = value * 100.00
        };

        const row = document.createElement("div");
        row.className = "stat";

        const label = document.createElement("div");
        label.className = "stat-name";
        label.textContent = name;

        const val = document.createElement("div");
        val.className = "stat-value";
        if (name == "Percent Unique") {
          val.textContent = `${value}%`;
        } else 
        { val.textContent = value; };

        row.appendChild(label);
        row.appendChild(val);
        return row;
      }
    </script>

  </body>
</html>
